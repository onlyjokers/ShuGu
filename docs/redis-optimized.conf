# ===== Redis 优化配置 (2GB RAM / 2 Core 服务器) =====
# 用途：Socket.io Redis Adapter（消息传递，不需要持久化）
# 
# 使用方法：
# 1. 备份原配置：sudo cp /etc/redis/redis.conf /etc/redis/redis.conf.backup
# 2. 应用此配置：sudo cp redis-optimized.conf /etc/redis/redis.conf
# 3. 重启 Redis：sudo systemctl restart redis-server
#
# =========================================================

# ----- 网络配置 -----
# 只允许本地连接（安全）
bind 127.0.0.1 ::1

# 默认端口
port 6379

# 保护模式（防止远程连接）
protected-mode yes

# 禁用 IPv6（如果不需要）
# bind 127.0.0.1

# ----- 内存管理 -----
# 最大内存限制：128MB（对于你的场景足够了）
# Socket.io adapter 只存储临时消息，不需要大量内存
maxmemory 128mb

# 内存淘汰策略：删除最近最少使用的键
# 当内存满时，自动删除旧消息
maxmemory-policy allkeys-lru

# 样本大小（LRU 算法）
maxmemory-samples 5

# ----- 持久化（全部禁用） -----
# Socket.io adapter 不需要持久化，禁用可提升性能

# 禁用 RDB 快照
save ""

# 禁用 AOF 日志
appendonly no

# 如果之前启用了 AOF，关闭时不重写
aof-rewrite-incremental-fsync no

# ----- 性能优化 -----
# 最大 Redis 客户端连接数（注意：不是 Socket.io 用户数！）
# 单个 Node.js 服务器只用 2 个连接（pub + sub）
# 设置为 1000 以支持未来多服务器扩展
maxclients 1000

# TCP backlog（连接队列）
tcp-backlog 128

# 超时时间（0 表示永不超时）
timeout 0

# TCP keepalive（300秒检测一次死连接）
tcp-keepalive 300

# 日志级别（生产环境用 notice 或 warning）
loglevel notice

# 日志文件位置
logfile /var/log/redis/redis-server.log

# 数据库数量（我们只用一个）
databases 1

# ----- 高级配置 -----
# 慢查询日志（帮助诊断性能问题）
slowlog-log-slower-than 10000  # 10ms 以上的命令记录
slowlog-max-len 128

# 延迟监控
latency-monitor-threshold 100  # 100ms 以上的延迟记录

# 禁用某些危险命令（可选）
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command CONFIG ""

# ----- 内存分配优化 -----
# 使用 jemalloc（Redis 默认）
# maxmemory-policy 已经设置为 allkeys-lru

# 后台保存时不使用 COW（copy-on-write）
# 因为我们禁用了持久化，这个无关紧要
stop-writes-on-bgsave-error no

# 压缩优化（对小数据集无关紧要）
rdbcompression no
rdbchecksum no

# ----- 复制配置（单机部署不需要） -----
# 如果未来要做主从复制，取消下面的注释
# replicaof <masterip> <masterport>
# replica-read-only yes

# ----- 监控相关 -----
# 启用统计信息
# Redis 会跟踪命令执行次数等信息
enable-statistics yes
